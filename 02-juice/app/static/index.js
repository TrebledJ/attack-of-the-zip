function e(){function a(e){var t=i.createElement("link");t.type="image/x-icon",t.rel="icon",t.href=e,e=n.getElementsByTagName("link");for(var s=0;s<e.length;s++)/\bicon\b/i.test(e[s].getAttribute("rel"))&&n.removeChild(e[s]);n.appendChild(t)}var i=document,n=i.getElementsByTagName("head")[0],o=null;return{defaultPause:2e3,change:function(e,t){clearTimeout(o),t&&(i.title=t),""!==e&&a(e)},animate:function(t,s){clearTimeout(o),t.forEach(function(e){(new Image).src=e}),s=s||this.defaultPause;var i=0;a(t[i]),o=setTimeout(function e(){i=(i+1)%t.length,a(t[i]),o=setTimeout(e,s)},s)},stopAnimate:function(){clearTimeout(o)}}}function s({method:e,url:a,headers:n,responseType:o,params:r,form:d,onprogress:u,uploadonprogress:h}){return new Promise(function(t,s){var i=new XMLHttpRequest;i.open(e,a),o&&(i.responseType=o),i.onload=function(e){200<=i.status&&i.status<300?t(i.response):s({status:i.status,statusText:i.statusText})},i.onerror=function(){console.log("error:",i.status),s({status:i.status,statusText:i.statusText})},u&&(i.onprogress=u),h&&(i.upload.onprogress=h),n&&Object.keys(n).forEach(function(e){i.setRequestHeader(e,n[e])}),r?("object"==typeof r&&(r=Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")),i.send(r)):d?i.send(d):i.send()})}"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():("undefined"!=typeof self?self:this).favicon=e();const i=(e,t,s)=>Math.max(t,Math.min(e,s)),a=e=>{var{left:e,top:t,width:s,height:i}=e.getBoundingClientRect();return{x:e+s/2,y:t+i/2}},n=(e,t)=>Math.atan2(t.y-e.y,t.x-e.x),o=(e,t)=>Math.atan2(Math.sin(e-t),Math.cos(e-t)),t=.75,r=60*t,d=r*Math.PI*2,u=d/60,h=.001*u,l=2*Math.PI;class m{constructor(e,t){this.elContainer=e,this.elDiscs=t,this._isPoweredOn=!1,this._playbackSpeed=1,this._duration=0,this._isDragging=!1,this.centers=this.elDiscs.map(a),this.angle=0,this.anglePrevious=0,this.maxAngle=l,this.rafId=null,this.timestampPrevious=performance.now(),this.draggingSpeeds=[],this.draggingFrom={},this.isReversed=!1,this.onDragStart=this.onDragStart.bind(this),this.onDragProgress=this.onDragProgress.bind(this),this.onDragEnd=this.onDragEnd.bind(this),this.loop=this.loop.bind(this),this.callbacks={onDragEnded:()=>{},onAutoRotate:()=>{},onStop:()=>{},onLoop:()=>{}},this.currDragDisc=null,this.init()}init(){this.elDiscs.forEach((e,t)=>e.addEventListener("pointerdown",e=>this.onDragStart(e,t)))}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){this.draggingSpeeds.push(e),this.draggingSpeeds=this.draggingSpeeds.slice(Math.max(0,this.draggingSpeeds.length-10));e=this.draggingSpeeds.reduce((e,t)=>e+t,0)/this.draggingSpeeds.length;this._playbackSpeed=i(e,-4,4)}get secondsPlayed(){return this.angle/l/t}get duration(){return this._duration}set duration(e){this._duration=e,this.maxAngle=e*t*l}set isDragging(t){this._isDragging=t,this.elDiscs.forEach(e=>e.classList.toggle("is-scratching",t))}get isDragging(){return this._isDragging}powerOn(){this._isPoweredOn=!0,this._playbackSpeed=1,this.start()}powerOff(){this._isPoweredOn=!1,this.stop()}onDragStart(e,t){this.currDragDisc=t,document.body.addEventListener("pointermove",this.onDragProgress),document.body.addEventListener("pointerup",this.onDragEnd),this.centers[t]=a(this.elDiscs[t]),this.draggingFrom={x:e.clientX,y:e.clientY},this.isDragging=!0}onDragProgress(e){e.preventDefault();var{clientX:e,clientY:t}=e,e={x:e,y:t},t=n(this.centers[this.currDragDisc],e),s=n(this.centers[this.currDragDisc],this.draggingFrom),s=o(s,t);this.setAngle(this.angle-s),this.draggingFrom={...e},this.setState()}onDragEnd(){document.body.removeEventListener("pointermove",this.onDragProgress),document.body.removeEventListener("pointerup",this.onDragEnd),this.currDragDisc=null,this.isDragging=!1,this.playbackSpeed=1,this.callbacks.onDragEnded(this.secondsPlayed)}autoRotate(e){var e=e-this.timestampPrevious,t=h*e*this.playbackSpeed;t+=.1,t=i(t,0,h*e),this.setAngle(this.angle+t)}setState(){this.elContainer.style.setProperty("--disc-angle",this.angle+"rad")}setAngle(e){return this.angle=i(e,0,this.maxAngle),this.angle}start(){this.isDragging=!1,this.isReversed=!1,this.anglePrevious=this.angle,this.timestampPrevious=performance.now(),this.draggingSpeeds=[1],this._playbackSpeed=1,this.loop()}stop(){cancelAnimationFrame(this.rafId),this.callbacks.onStop()}rewind(){this.setAngle(0)}loop(){var e,t,s,i;this._isPoweredOn&&(t=performance.now(),this.isDragging||this.autoRotate(t),t=t-this.timestampPrevious,e=this.angle-this.anglePrevious,t=h*t,{playbackSpeed:e,isReversed:t,secondsPlayed:s,duration:i}=(this.playbackSpeed=e/t||1,this.isReversed=this.angle<this.anglePrevious,this.anglePrevious=this.angle,this.timestampPrevious=performance.now(),this.setState(),this),this.callbacks.onLoop({playbackSpeed:e,isReversed:t,secondsPlayed:s,progress:s/i}),this.anglePrevious=this.angle,this.rafId=requestAnimationFrame(this.loop))}}class f{constructor(){this.audioContext=new AudioContext,this.gainNode=this.audioContext.createGain(),this.audioBuffer=null,this.audioBufferReversed=null,this.audioSource=null,this.duration=0,this.speedPrevious=0,this.isReversed=!1,this.gainNode.connect(this.audioContext.destination),this.onended=()=>{}}async getArrayBufferFromUrlWithProgress(e){return w.download(e,{responseType:"arraybuffer"}).then(e=>(w.status="Loading audio...",e),()=>{})}async getArrayBufferFromUrl(e){return(await fetch(e)).arrayBuffer()}async getAudioBuffer(e){e=await this.getArrayBufferFromUrlWithProgress(e);return this.audioContext.decodeAudioData(e)}async loadTrack(e){this.audioBuffer=await this.getAudioBuffer(e),this.audioBufferReversed=this.getReversedAudioBuffer(this.audioBuffer),this.duration=this.audioBuffer.duration}getReversedAudioBuffer(e){var t=e.getChannelData(0).slice().reverse(),e=this.audioContext.createBuffer(1,e.length,e.sampleRate);return e.getChannelData(0).set(t),e}changeDirection(e,t){this.isReversed=e,this.play(t)}play(e=0){this.pause();var t=this.isReversed?this.audioBufferReversed:this.audioBuffer,e=this.isReversed?this.duration-e:e;this.audioSource=this.audioContext.createBufferSource(),this.audioSource.buffer=t,this.audioSource.loop=!1,this.audioSource.addEventListener("ended",this.onended),this.audioSource.connect(this.gainNode),this.audioSource.start(0,e)}onEnded(e){this.onended=e}updateSpeed(e,t,s){this.audioSource&&(t!==this.isReversed&&this.changeDirection(t,s),t=this.audioContext["currentTime"],this.audioSource.playbackRate.cancelScheduledValues(t),this.audioSource.playbackRate.linearRampToValueAtTime(Math.max(.001,Math.abs(e)),t))}toggleMute(e){this.gainNode.gain.value=e?0:1}pause(){this.audioSource&&this.audioSource.stop()}}class b{constructor({toggleButton:e,rewindButton:t}){this.toggleButton=e,this.rewindButton=t,this.isPlaying=!1,this.toggleButton.addEventListener("click",e=>this.toggle(e)),this.rewindButton.addEventListener("click",e=>this.rewind(e)),document.body.addEventListener("keydown",e=>this.onKeyDown(e)),document.body.addEventListener("keyup",e=>this.onKeyUp(e)),this.callbacks={onIsPlayingChanged:()=>{},onRewind:()=>{},onToggleMuted:()=>{}}}set label(e){this.toggleButton.textContent=e}set isDisabled(e){this.toggleButton.disabled=e}onKeyDown({key:e,repeat:t}){t||"m"!==e||this.callbacks.onToggleMuted(!0)}onKeyUp({key:e}){"m"===e&&this.callbacks.onToggleMuted(!1)}toggle(){this.isPlaying=!this.isPlaying,this.callbacks.onIsPlayingChanged(this.isPlaying)}rewind(){this.callbacks.onRewind()}stop(){this.isPlaying&&this.toggle()}}class v{constructor({progressBar:e,statusText:t}){this.progressBar=e,this.statusText=t,this.busy=!1}get running(){return this.busy}upload(e,t){if(this.running)throw new Error("upload: ProgressRequest is busy.");return this.ot=(new Date).getTime(),this.oloaded=0,this.start(),s({method:"POST",url:e,form:t,uploadonprogress:this.onprogress.bind(this)}).then(e=>(this.finish(),e)).catch(({status:e,statusText:t})=>{throw this.finish(),this.status=413==e?"Upload file(s) too large!":"Upload failed... Try using a smaller file?",new Error({status:e,statusText:t})})}download(e,{responseType:t}){if(this.running)throw new Error("download: ProgressRequest is busy.");return this.start(),s({method:"GET",url:e,onprogress:this.onprogress.bind(this),responseType:t}).then(e=>(this.finish(),e)).catch(({status:e,statusText:t})=>{throw this.finish(),this.status="Audio download failed.",new Error({status:e,statusText:t})})}onprogress(e){e.lengthComputable&&this.updateBar(Math.round(e.loaded/e.total*100)+"%")}cancel(){this.xhr.abort(),this.finish()}set status(e){this.statusText.innerText=e}get status(){return this.statusText.innerText}start(){this.showBar(),this.busy=!0}finish(){this.hideBar(),this.busy=!1}hideBar(){this.progressBar.style.opacity=0,this.progressBar.style.setProperty("--progress","0%")}showBar(){this.progressBar.style.opacity=1,this.progressBar.style.setProperty("--progress","0%")}updateBar(e){this.progressBar.style.setProperty("--progress",e)}}var w;function c(){w=new v({progressBar:document.querySelector("#progressBar"),statusText:document.querySelector("#statusText")});var e=document.querySelector(".turntable");const n=new m(e,[...document.querySelectorAll(".disc")]),o=new f,a=new b({toggleButton:document.querySelector("#playButton"),rewindButton:document.querySelector("#rewind")}),t=document.getElementById("audioFile"),s=document.getElementById("scoreFile"),i=document.getElementById("uploadButton"),r=document.getElementById("playButton"),d=document.getElementById("playButton__text"),u=document.getElementById("djcat"),h=document.getElementById("disc__label__audio"),l=document.getElementById("disc__label__score");var c=!1,g=!1;function p(){c&&g&&(i.removeAttribute("hide"),r.removeAttribute("hide"),document.querySelector("body").setAttribute("dark",""),h.removeAttribute("active"),l.removeAttribute("active"),document.querySelectorAll(".disc__label__fb").forEach(e=>e.setAttribute("active","")))}function y(){i.disabled=!1}n.duration=o.duration,n.callbacks.onDragEnded=()=>{a.isPlaying&&o.play(n.secondsPlayed)},n.callbacks.onStop=()=>o.pause(),n.callbacks.onLoop=({playbackSpeed:e,isReversed:t,secondsPlayed:s,progress:i})=>{.9999<i&&(a.stop(),a.rewind()),o.updateSpeed(e,t,s)},a.callbacks.onIsPlayingChanged=e=>{e?(n.powerOn(),o.play(n.secondsPlayed),d.innerText="Stop",favicon.change("static/assets/ablobcatdj.webp"),u.classList.add("active")):(n.powerOff(),d.innerText="Play",favicon.change("static/assets/ablobcatdjslow.webp"),u.classList.remove("active"))},a.callbacks.onRewind=()=>{n.rewind()},a.callbacks.onToggleMuted=e=>{o.toggleMute(e)},h.addEventListener("click",function(){t.click()}),l.addEventListener("click",function(){s.click()}),t.addEventListener("change",function(){document.getElementById("disc__background__audio").setAttribute("active",""),c=!0,p()}),s.addEventListener("change",function(){document.getElementById("disc__background__score").setAttribute("active",""),g=!0,p()}),i.addEventListener("click",function(){i.disabled=!0,r.disabled=!0,a.stop(),d.innerText="Play",w.status="Uploading...";var e=new FormData;e.append("audio",document.getElementById("audioFile").files[0]),e.append("score",document.getElementById("scoreFile").files[0]),w.upload("/upload",e).then(e=>{w.status="Files uploaded!";const t=e,a=(w.status="...",setInterval(function(){var s,i;s=t,i=a,s&&fetch("/status?id="+s).then(async e=>{var t,e=await e.text();"Done"===e?(clearInterval(i),t="/audio?id="+s,await o.loadTrack(t),await!(n.duration=o.duration),w.status="Audio loaded!",n.rewind(),y(),r.disabled=!1):e.startsWith("Fail")?(w.status=e,clearInterval(i),y()):"None"===e?w.status="Bad Request (maybe?)":w.status.startsWith(e)?w.status+=".":w.status=e+"..."}).catch(e=>console.log(e))},5e3))},()=>{y()})})}"loading"!==document.readyState?c():document.addEventListener("DOMContentLoaded",function(){c()});